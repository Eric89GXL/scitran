# This file is templated by scitran.py.
# Edits to the generated file will not be saved!

mongo:
    image: scitran-mongo:0
    volumes:
        - SCITRAN-CWD/data/mongo:/data/db
    expose:
        - "21707"
    command: mongod
api:
    image: scitran-api:0
    # NOTE: If these volumes change, scitran.py bootstrapping must as well.
    volumes:
        - SCITRAN-CWD/api:/service/config
        - SCITRAN-CWD/code:/service/code
        - SCITRAN-CWD/data/blocks:/service/blocks
        - SCITRAN-CWD/data/log:/service/log
    ports:
        - "3031"
    links:
        - mongo
    environment:
      - PYTHONPATH=/service/code/data
    command:  "uwsgi     \
    --socket [::]:3031 \
        --chmod-socket \
        --chdir /service/code/api \
        --wsgi-file api.wsgi \
        --master \
        --processes 2 \
        --threads 2 \
        --die-on-term \
        --logto /service/log/api.log \
        --pythonpath /service/code/data \
        --pyargv 'SCITRAN-SITE-ID \
                  SCITRAN-SITE-NAME \
                --api_uri https://127.0.0.1/api \
                --db_uri mongodb://mongo/nims \
                --data_path /service/blocks \
                --ssl_cert /service/config/key+cert.pem \
                SCITRAN-CENTRAL-URL \
                SCITRAN-DEMO \
                --oauth2_id_endpoint SCITRAN-AUTH-TOKEN-ENDPOINT'
    "

nginx:
    image: scitran-nginx:0
    volumes:
        - SCITRAN-CWD/nginx:/etc/nginx
        - SCITRAN-CWD/data/log:/service/log
        - SCITRAN-CWD/code/sdm/app:/service/web
    ports:
        - "80:80"
        - "443:443"
    links:
        - api
    command: nginx
